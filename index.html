<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hand Tracking + Voice Gestures</title>
  <style>
    body{margin:0;background:#0f1724;color:#e6eef6;font-family:sans-serif;display:flex;justify-content:center;padding:20px;}
    .app{max-width:1000px;width:100%;display:grid;grid-template-columns: 640px 1fr;gap:16px;}
    .card{background:#1a2336;border-radius:10px;padding:12px;}
    .video-wrap{position:relative;border-radius:10px;overflow:hidden;background:#000;height:480px;}
    video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
    canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;transform:scaleX(-1);}
    h2{margin-top:0;}
    ul{padding-left:18px;}
    input,button{padding:6px 10px;margin:4px 0;}
    button{cursor:pointer;border-radius:6px;border:none;}
    .primary{background:#06b6d4;color:#021018;font-weight:bold;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="video-wrap">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
    </div>
    <p>Gesture terdeteksi: <b id="gesture">—</b></p>
    <button class="primary" id="btnCamera">Start Camera</button>
  </div>

  <div class="card">
    <h2>Daftar Gesture</h2>
    <ul id="gestureList"></ul>

    <h3>Tambah Gesture Baru</h3>
    <p><i>Format gesture harus sudah ada di kode deteksi (misalnya: one_finger, two_fingers, dll.)</i></p>
    <input type="text" id="gestureName" placeholder="Nama gesture (contoh: one_finger)" style="width:100%"><br/>
    <input type="text" id="gestureResponse" placeholder="Respon suara (contoh: Halo!)" style="width:100%"><br/>
    <button id="addGesture">Tambah Gesture</button>
  </div>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const gestureLabel = document.getElementById("gesture");
const btnCamera = document.getElementById("btnCamera");
const gestureList = document.getElementById("gestureList");

// Mapping gesture -> respon suara
let gestureResponses = {
  "open_palm": "Halo",
  "one_finger": "Kalp",
  "two_fingers": "Nama",
  "thumbs_up": "Bagus"
};

// Render daftar gesture
function renderGestureList(){
  gestureList.innerHTML = "";
  Object.entries(gestureResponses).forEach(([g,res])=>{
    const li = document.createElement("li");
    li.textContent = `${g} → "${res}"`;
    gestureList.appendChild(li);
  });
}
renderGestureList();

// Fungsi bicara
function speak(text){
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "id-ID";
  speechSynthesis.speak(utter);
}

// Gesture detection sederhana
function detectGesture(landmarks){
  const tips = [4,8,12,16,20];
  const pips = [3,6,10,14,18];
  const ext = [];
  for(let i=0;i<5;i++){
    const tip=landmarks[tips[i]], pip=landmarks[pips[i]];
    ext[i]= tip && pip ? tip.y < pip.y : false;
  }
  const count = ext.filter(Boolean).length;
  if(count>=4) return "open_palm";
  if(ext[0] && !ext[1]&&!ext[2]&&!ext[3]&&!ext[4]) return "thumbs_up";
  if(ext[1] && !ext[0]&&!ext[2]&&!ext[3]&&!ext[4]) return "one_finger";
  if(ext[1]&&ext[2] && !ext[0]&&!ext[3]&&!ext[4]) return "two_fingers";
  return "unknown";
}

// MediaPipe setup
const hands = new Hands({locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({maxNumHands:1,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.6});
hands.onResults(onResults);

let camera = null;
async function startCamera(){
  if(camera) return;
  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject = stream;
  await video.play();
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  camera = new Camera(video,{onFrame:async()=>{await hands.send({image:video});},width:640,height:480});
  camera.start();
  btnCamera.textContent="Stop Camera";
}
function stopCamera(){
  if(camera){camera.stop();camera=null;}
  if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop());video.srcObject=null;}
  ctx.clearRect(0,0,canvas.width,canvas.height);
  btnCamera.textContent="Start Camera";
}
btnCamera.onclick=()=>{if(camera)stopCamera();else startCamera();};

// Handle hasil
let lastGesture="";
function onResults(results){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    const lm = results.multiHandLandmarks[0];
    window.drawConnectors(ctx,lm,window.HAND_CONNECTIONS,{color:"#0ff",lineWidth:3});
    window.drawLandmarks(ctx,lm,{color:"#ff0",lineWidth:2});
    const g=detectGesture(lm);
    gestureLabel.textContent=g;
    if(g!==lastGesture && g!=="unknown"){
      lastGesture=g;
      if(gestureResponses[g]) speak(gestureResponses[g]);
    }
  }else{
    gestureLabel.textContent="—";
    lastGesture="";
  }
}

// Tambah gesture custom
document.getElementById("addGesture").onclick=()=>{
  const g=document.getElementById("gestureName").value.trim();
  const r=document.getElementById("gestureResponse").value.trim();
  if(!g||!r) return alert("Isi nama gesture dan respon!");
  gestureResponses[g]=r;
  renderGestureList();
  alert(`Gesture "${g}" ditambahkan dengan respon "${r}"`);
};
</script>
</body>
</html>
