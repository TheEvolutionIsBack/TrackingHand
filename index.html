<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hand Gesture Voice ‚Äî Final (Full)</title>

<!-- MediaPipe CDN libs -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<style>
  :root{
    --bg:#071226; --card:#0c1624; --muted:#9fb0c3; --accent:#06b6d4;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;}
  body{margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg),#041423); color:#e6edf3; font-family:Inter,system-ui,Helvetica,Arial; display:flex; justify-content:center; padding:20px;}
  .wrap{width:100%; max-width:1100px; display:grid; grid-template-columns:680px 1fr; gap:18px;}
  .card{background:var(--card); border-radius:12px; padding:12px; box-shadow: 0 8px 30px rgba(2,8,23,0.6); border:1px solid rgba(255,255,255,0.02);}
  .video-box{position:relative; width:100%; height:480px; border-radius:10px; overflow:hidden; background:#000;}
  #video{width:100%; height:100%; object-fit:cover; transform:scaleX(-1);}
  #canvas{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; transform:scaleX(-1);}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  button{padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--glass); color:var(--muted);}
  button.primary{background:linear-gradient(90deg,var(--accent),#7dd3fc22); color:#021018; font-weight:700;}
  input, select {padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit;}
  label{font-size:13px; color:var(--muted);}
  .small{font-size:13px; color:var(--muted);}
  .list{display:flex; flex-direction:column; gap:10px;}
  .gesture-item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg,#071a23,#06202b); border:1px solid rgba(255,255,255,0.02);}
  .gesture-left{display:flex; gap:8px; align-items:center;}
  .badge{font-size:12px; color:var(--muted);}
  .bubble-area{position:relative; min-height:60px;}
  .bubble{position:absolute; right:10px; background:#0ea5a9; color:#021018; padding:10px 14px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.4); animation:pop .28s ease;}
  @keyframes pop{from{transform:translateY(6px) scale(.98);opacity:0} to{transform:translateY(0) scale(1);opacity:1}}
  .muted-box{background:#071826;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.02);}
  .footer-note{font-size:12px;color:var(--muted); margin-top:8px;}
  .highlight{box-shadow:0 0 18px rgba(6,182,212,0.18); border:1px solid rgba(6,182,212,0.12);}
  .row{display:flex; gap:8px; align-items:center;}
  .flex-col{display:flex;flex-direction:column;gap:8px;}
  .tiny{font-size:12px;color:var(--muted);}
  .handLabel{font-size:12px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);}

  /* small toggles style inline with design */
  .toggles { display:flex; gap:8px; align-items:center; }
  .toggles label { background: rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; display:flex; align-items:center; gap:6px; color:var(--muted); border:1px solid rgba(255,255,255,0.02); }
  .toggles input[type="checkbox"]{ width:16px;height:16px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="video-box" id="videoWrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
      </div>

      <div class="controls">
        <button id="btnCamera" class="primary">Start Camera</button>
        <button id="btnFullscreen">üñ•Ô∏è Fullscreen Kamera</button>
        <button id="btnRecord">üé• Rekam Gestur</button>
        <button id="btnStopRecord">‚èπÔ∏è Stop Rekam</button>
        <button id="btnAutoName">üîÄ Auto-Name</button>
        <button id="btnSnapshot">üì∏ Snapshot</button>
        <a id="downloadLink" style="display:none"></a>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px;align-items:center;justify-content:space-between;">
        <div style="flex:1 1 auto; display:flex; gap:12px; align-items:center;">
          <div style="flex:1;">
            <label class="small">Nama Gestur</label><br>
            <input id="gestureName" placeholder="kosongkan untuk auto-name" style="width:100%;">
          </div>
          <div style="flex:1;">
            <label class="small">Respon Suara</label><br>
            <input id="gestureResponse" placeholder="Contoh: Halo!" style="width:100%;">
          </div>
        </div>
        <div style="width:160px;">
          <label class="small">Cooldown (ms)</label><br>
          <input id="gestureCooldown" type="number" value="2500" style="width:100%;">
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-top:8px;align-items:center;">
        <div style="flex:1;">
          <label class="small">Sensitivity (threshold)</label>
          <input id="sensitivity" type="range" min="0.8" max="5.0" step="0.1" value="3.0" style="width:100%;">
          <div class="tiny">Nilai lebih kecil = lebih ketat (lebih sulit cocok). Saat ini: <span id="sVal">3.0</span></div>
        </div>
        <div style="width:220px; display:flex; flex-direction:column; gap:6px;">
          <label class="small">Global cooldown (ms)</label>
          <input id="globalCooldown" type="number" value="500" style="width:100%;">
          <div class="toggles" style="margin-top:6px;">
            <label><input id="toggleHand" type="checkbox" checked> Hand</label>
            <label><input id="toggleFace" type="checkbox" checked> Face</label>
            <label><input id="toggleVoice" type="checkbox" checked> Voice</label>
            <label><input id="toggleBubble" type="checkbox" checked> Bubble</label>
          </div>
        </div>
      </div>

      <div class="muted-box" style="margin-top:12px;">
        <div id="status" class="small">Status: menunggu kamera...</div>
        <div class="footer-note">Tips: tahan tombol <b>Rekam Gestur</b> selama ~1 detik untuk merekam beberapa frame. Setelah tersimpan, tunjukkan gestur untuk memicu respon suara. Kamera & FaceMesh berjalan bersamaan.</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Daftar Gestur & Ekspresi</h3>
        <div style="display:flex;gap:8px;">
          <button id="exportBtn">‚¨áÔ∏è Export</button>
          <input type="file" id="importFile" style="display:none"/>
          <button id="importBtn">‚¨ÜÔ∏è Import</button>
          <button id="clearBtn">üóëÔ∏è Clear All</button>
        </div>
      </div>

      <div id="gesturesList" class="list" style="margin-top:10px;max-height:320px;overflow:auto;"></div>

      <div style="margin-top:12px;">
        <div class="bubble-area" id="bubbleArea"></div>
      </div>

      <div style="margin-top:12px;" class="flex-col">
        <div class="row">
          <button id="saveBtn" class="primary">üíæ Simpan Gestur</button>
          <button id="applySettings">Apply Settings</button>
        </div>
        <div class="small">Export/Import menyimpan seluruh template gesture (JSON). Simpan gesture sebelum export. Face expression auto diaktifkan ‚Äî ada setting cooldown wajah di bawah.</div>
        <div style="margin-top:8px;">
          <label class="small">Face cooldown (ms)</label>
          <input id="faceCooldown" type="number" value="3000" style="width:120px;">
        </div>
      </div>
    </div>
  </div>

<script>
/* ============================================================
   Final script ‚Äî multi-hand recording & matching,
   face heuristics (anti-blink), bubble stacking,
   localStorage save/load, cooldown fixes.
   Ekspresi hanya trigger saat berubah.
   ============================================================ */

/* ====== DOM & State ====== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const btnCamera = document.getElementById('btnCamera');
const btnFullscreen = document.getElementById('btnFullscreen');
const btnRecord = document.getElementById('btnRecord');
const btnStopRecord = document.getElementById('btnStopRecord');
const btnAutoName = document.getElementById('btnAutoName');
const btnSnapshot = document.getElementById('btnSnapshot');
const downloadLink = document.getElementById('downloadLink');

const gestureNameInput = document.getElementById('gestureName');
const gestureResponseInput = document.getElementById('gestureResponse');
const gestureCooldownInput = document.getElementById('gestureCooldown');
const sensitivityRange = document.getElementById('sensitivity');
const sVal = document.getElementById('sVal');
const globalCooldownInput = document.getElementById('globalCooldown');
const statusEl = document.getElementById('status');
const gesturesListEl = document.getElementById('gesturesList');
const bubbleArea = document.getElementById('bubbleArea');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const clearBtn = document.getElementById('clearBtn');
const applySettingsBtn = document.getElementById('applySettings');
const faceCooldownInput = document.getElementById('faceCooldown');

const toggleHand = document.getElementById('toggleHand');
const toggleFace = document.getElementById('toggleFace');
const toggleVoice = document.getElementById('toggleVoice');
const toggleBubble = document.getElementById('toggleBubble');

let cameraObj = null;
let recording = false;
let recordFrames = [];
const RECORD_FRAME_COUNT = 18;
let templates = [];
let lastGlobalTrigger = 0;
let lastFaceTrigger = 0;
let lastFaceExpression = null; // baru: ekspresi terakhir

/* ====== UI hookups ====== */
sensitivityRange.addEventListener('input', ()=> sVal.innerText = sensitivityRange.value );

/* ====== Speech & bubble ====== */
function speak(text){
  if(!toggleVoice.checked) return;
  const now = Date.now();
  const globalCd = parseInt(globalCooldownInput.value)||500;
  if(now - lastGlobalTrigger < globalCd) return;
  lastGlobalTrigger = now;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = document.documentElement.lang || "id-ID";
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
  if(toggleBubble.checked) showBubble(text);
}
function showBubble(text){
  if(!toggleBubble.checked) return;
  const children = bubbleArea.children.length;
  const el = document.createElement('div');
  el.className = 'bubble';
  el.style.bottom = `${children*56}px`;
  el.innerText = text;
  bubbleArea.appendChild(el);
  setTimeout(()=>bubbleArea.removeChild(el), 3500);
}

/* ====== Gestures Storage ====== */
function renderGestures(){
  gesturesListEl.innerHTML = '';
  templates.forEach((g,i)=>{
    const div = document.createElement('div');
    div.className = 'gesture-item';
    div.innerHTML = `<div class="gesture-left">
      <span>${g.name||'No Name'}</span>
      <span class="badge">${g.response||''}</span>
    </div>
    <div>
      <button onclick="templates.splice(${i},1);renderGestures()">‚ùå</button>
    </div>`;
    gesturesListEl.appendChild(div);
  });
}
function saveTemplates(){ localStorage.setItem('gestures',JSON.stringify(templates)); renderGestures(); }
function loadTemplates(){ const d = localStorage.getItem('gestures'); if(d) templates=JSON.parse(d); renderGestures(); }
loadTemplates();

/* ====== Camera & MediaPipe ====== */
function startCamera(){
  cameraObj = new Camera(video,{
    onFrame: async()=>{
      await hands.send({image:video});
      await faceMesh.send({image:video});
    },
    width:680,
    height:480
  });
  cameraObj.start();
}
btnCamera.addEventListener('click',startCamera);
btnFullscreen.addEventListener('click',()=>{video.requestFullscreen();});

/* ====== Hands ====== */
const hands = new Hands({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:2,modelComplexity:1, minDetectionConfidence:0.7,minTrackingConfidence:0.7});
hands.onResults(onHandsResults);

function onHandsResults(results){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!toggleHand.checked) return;
  if(results.multiHandLandmarks && results.multiHandLandmarks.length>0){
    for(const landmarks of results.multiHandLandmarks){
      drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color:'#0ff', lineWidth:2});
      drawLandmarks(ctx, landmarks, {color:'#0ff', lineWidth:1});
    }
    // Trigger gesture match
    matchGestures(results.multiHandLandmarks);
  }
}

/* ====== FaceMesh ====== */
let eyeClosedSince = null;
const FACE_YAWN_THRESHOLD = 0.06;
const FACE_SLEEP_THRESHOLD = 0.04;
const FACE_SMILE_WIDTH = 0.06;
const FACE_SAD_THRESHOLD = 0.035;

const faceMesh = new FaceMesh({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
faceMesh.setOptions({maxNumFaces:1,minDetectionConfidence:0.7,minTrackingConfidence:0.7});
faceMesh.onResults(onFaceResults);

function faceMetrics(landmarks){
  // contoh simple: mouthOpen, leftEye, rightEye, frown
  const mouthOpen = Math.hypot(
    landmarks[13].x - landmarks[14].x,
    landmarks[13].y - landmarks[14].y
  );
  const leftEye = Math.hypot(landmarks[159].x-landmarks[145].x, landmarks[159].y-landmarks[145].y);
  const rightEye = Math.hypot(landmarks[386].x-landmarks[374].x, landmarks[386].y-landmarks[374].y);
  const mouthWidth = Math.hypot(landmarks[78].x-landmarks[308].x, landmarks[78].y-landmarks[308].y);
  const leftFrown = landmarks[55].y - landmarks[65].y;
  const rightFrown = landmarks[285].y - landmarks[295].y;
  return {mouthOpen,leftEye,rightEye,mouthWidth,leftFrown,rightFrown};
}

function onFaceResults(results){
  if(!toggleFace.checked) return;
  if(results.multiFaceLandmarks && results.multiFaceLandmarks.length>0){
    const face = results.multiFaceLandmarks[0];
    window.drawConnectors(ctx, face, window.FACEMESH_TESSELATION, {color:'#ffffff22', lineWidth:1});
    const m = faceMetrics(face);
    const now = Date.now();
    const faceCd = parseInt(faceCooldownInput.value) || 3000;

    let currentExp = null;

    // Yawn detection
    if(m.mouthOpen > FACE_YAWN_THRESHOLD) currentExp='yawn';
    // Sleep detection
    else if(m.leftEye < FACE_SLEEP_THRESHOLD && m.rightEye < FACE_SLEEP_THRESHOLD){
      if(!eyeClosedSince) eyeClosedSince = now;
      else if(now-eyeClosedSince>1500) currentExp='sleep';
    } else eyeClosedSince=null;
    // Smile detection
    if(m.mouthWidth>FACE_SMILE_WIDTH && m.mouthOpen<0.035) currentExp='smile';
    // Sad detection
    if(m.leftFrown<FACE_SAD_THRESHOLD || m.rightFrown<FACE_SAD_THRESHOLD) currentExp='sad';

    if(currentExp && currentExp!==lastFaceExpression){
      if(now-lastFaceTrigger>faceCd){
        lastFaceTrigger=now;
        lastFaceExpression=currentExp;
        switch(currentExp){
          case 'yawn': speak('Kamu kelihatan menguap, istirahat dulu ya'); statusEl.innerText='üòÆ Terlihat menguap'; break;
          case 'sleep': speak('Kamu mengantuk, jangan dipaksa ya'); statusEl.innerText='üò¥ Terlihat mengantuk'; break;
          case 'smile': speak('Kamu tersenyum, bagus!'); statusEl.innerText='üòä Terlihat senyum'; break;
          case 'sad': speak('Kamu kelihatan sedih, semoga harimu segera membaik'); statusEl.innerText='üòî Terlihat sedih/murung'; break;
        }
      }
    }
    if(!currentExp) lastFaceExpression=null;
  }
}

/* ====== Gesture match ====== */
function matchGestures(handsLandmarks){
  const now = Date.now();
  const cd = parseInt(gestureCooldownInput.value)||2500;
  if(now - lastGlobalTrigger<cd) return;

  templates.forEach(g=>{
    if(matchTemplate(g.landmarks,handsLandmarks)){
      if(g.response) speak(g.response);
      lastGlobalTrigger = now;
    }
  });
}
function matchTemplate(templateLandmarks,currentLandmarks){
  // simple distance match
  if(!templateLandmarks || templateLandmarks.length===0) return false;
  if(currentLandmarks.length!==templateLandmarks.length) return false;
  let score=0;
  for(let i=0;i<templateLandmarks.length;i++){
    for(let j=0;j<templateLandmarks[i].length;j++){
      const t=templateLandmarks[i][j];
      const c=currentLandmarks[i][j];
      score+=Math.hypot(t.x-c.x,t.y-c.y);
    }
  }
  const threshold = parseFloat(sensitivityRange.value)||3.0;
  return score<threshold;
}

/* ====== Recording ====== */
btnRecord.addEventListener('click',()=>{recording=true; recordFrames=[]; statusEl.innerText='üé• Merekam...';});
btnStopRecord.addEventListener('click',()=>{recording=false; if(recordFrames.length>0){saveNewGesture(recordFrames); statusEl.innerText='‚úÖ Rekaman selesai';}});
function saveNewGesture(frames){
  const name = gestureNameInput.value || `Gesture-${templates.length+1}`;
  const response = gestureResponseInput.value || '';
  templates.push({name,response,landmarks:frames});
  saveTemplates();
}

/* ====== Snapshot ====== */
btnSnapshot.addEventListener('click',()=>{
  const data = canvas.toDataURL('image/png');
  downloadLink.href = data;
  downloadLink.download = 'snapshot.png';
  downloadLink.click();
});

/* ====== Export / Import ====== */
exportBtn.addEventListener('click',()=>{
  const blob = new Blob([JSON.stringify(templates)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  downloadLink.href=url;
  downloadLink.download='gestures.json';
  downloadLink.click();
});
importBtn.addEventListener('click',()=>importFile.click());
importFile.addEventListener('change',e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload=()=>{ templates=JSON.parse(reader.result); saveTemplates(); };
  reader.readAsText(file);
});
clearBtn.addEventListener('click',()=>{ if(confirm('Clear semua gesture?')){templates=[]; saveTemplates();}});

/* ====== Apply Settings / Save ====== */
applySettingsBtn.addEventListener('click',()=>{statusEl.innerText='‚öôÔ∏è Settings diterapkan';});
saveBtn.addEventListener('click',saveTemplates);

</script>
</body>
</html>
