<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hand Gesture Voice ‚Äî Full Fixed Face Overlay</title>

<!-- MediaPipe CDN libs -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<style>
:root{
  --bg:#071226; --card:#0c1624; --muted:#9fb0c3; --accent:#06b6d4;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;}
body{margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg),#041423); color:#e6edf3; font-family:Inter,system-ui,Helvetica,Arial; display:flex; justify-content:center; padding:20px;}
.wrap{width:100%; max-width:1100px; display:grid; grid-template-columns:680px 1fr; gap:18px;}
.card{background:var(--card); border-radius:12px; padding:12px; box-shadow: 0 8px 30px rgba(2,8,23,0.6); border:1px solid rgba(255,255,255,0.02);}
.video-box{position:relative; width:100%; height:480px; border-radius:10px; overflow:hidden; background:#000;}
#video{width:100%; height:100%; object-fit:cover; transform:scaleX(-1);}
#canvas{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; transform:scaleX(-1);}
.controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
button{padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--glass); color:var(--muted);}
button.primary{background:linear-gradient(90deg,var(--accent),#7dd3fc22); color:#021018; font-weight:700;}
input, select {padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit;}
label{font-size:13px; color:var(--muted);}
.small{font-size:13px; color:var(--muted);}
.list{display:flex; flex-direction:column; gap:10px;}
.gesture-item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg,#071a23,#06202b); border:1px solid rgba(255,255,255,0.02);}
.gesture-left{display:flex; gap:8px; align-items:center;}
.badge{font-size:12px; color:var(--muted);}
.bubble-area{position:relative; min-height:60px;}
.bubble{position:absolute; right:10px; background:#0ea5a9; color:#021018; padding:10px 14px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.4); animation:pop .28s ease;}
@keyframes pop{from{transform:translateY(6px) scale(.98);opacity:0} to{transform:translateY(0) scale(1);opacity:1}}
.muted-box{background:#071826;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.02);}
.footer-note{font-size:12px;color:var(--muted); margin-top:8px;}
.highlight{box-shadow:0 0 18px rgba(6,182,212,0.18); border:1px solid rgba(6,182,212,0.12);}
.row{display:flex; gap:8px; align-items:center;}
.flex-col{display:flex;flex-direction:column;gap:8px;}
.tiny{font-size:12px;color:var(--muted);}
.handLabel{font-size:12px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);}
.toggles { display:flex; gap:8px; align-items:center; }
.toggles label { background: rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; display:flex; align-items:center; gap:6px; color:var(--muted); border:1px solid rgba(255,255,255,0.02); }
.toggles input[type="checkbox"]{ width:16px;height:16px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="video-box" id="videoWrap">
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
      <button id="btnCamera" class="primary">Start Camera</button>
      <button id="btnFullscreen">üñ•Ô∏è Fullscreen Kamera</button>
      <button id="btnRecord">üé• Rekam Gestur</button>
      <button id="btnStopRecord">‚èπÔ∏è Stop Rekam</button>
      <button id="btnAutoName">üîÄ Auto-Name</button>
      <button id="btnSnapshot">üì∏ Snapshot</button>
      <a id="downloadLink" style="display:none"></a>
    </div>

    <div style="display:flex;gap:12px;margin-top:12px;align-items:center;justify-content:space-between;">
      <div style="flex:1 1 auto; display:flex; gap:12px; align-items:center;">
        <div style="flex:1;">
          <label class="small">Nama Gestur</label><br>
          <input id="gestureName" placeholder="kosongkan untuk auto-name" style="width:100%;">
        </div>
        <div style="flex:1;">
          <label class="small">Respon Suara</label><br>
          <input id="gestureResponse" placeholder="Contoh: Halo!" style="width:100%;">
        </div>
      </div>
      <div style="width:160px;">
        <label class="small">Cooldown (ms)</label><br>
        <input id="gestureCooldown" type="number" value="2500" style="width:100%;">
      </div>
    </div>

    <div style="display:flex;gap:12px;margin-top:8px;align-items:center;">
      <div style="flex:1;">
        <label class="small">Sensitivity (threshold)</label>
        <input id="sensitivity" type="range" min="0.8" max="5.0" step="0.1" value="3.0" style="width:100%;">
        <div class="tiny">Nilai lebih kecil = lebih ketat. Saat ini: <span id="sVal">3.0</span></div>
      </div>
      <div style="width:220px; display:flex; flex-direction:column; gap:6px;">
        <label class="small">Global cooldown (ms)</label>
        <input id="globalCooldown" type="number" value="500" style="width:100%;">
        <div class="toggles" style="margin-top:6px;">
          <label><input id="toggleHand" type="checkbox" checked> Hand</label>
          <label><input id="toggleFace" type="checkbox" checked> Face</label>
          <label><input id="toggleVoice" type="checkbox" checked> Voice</label>
          <label><input id="toggleBubble" type="checkbox" checked> Bubble</label>
        </div>
      </div>
    </div>

    <div class="muted-box" style="margin-top:12px;">
      <div id="status" class="small">Status: menunggu kamera...</div>
      <div class="footer-note">Tips: tahan tombol <b>Rekam Gestur</b> ~1 detik untuk merekam beberapa frame. Kamera & FaceMesh berjalan bersamaan.</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3 style="margin:0">Daftar Gestur & Ekspresi</h3>
      <div style="display:flex;gap:8px;">
        <button id="exportBtn">‚¨áÔ∏è Export</button>
        <input type="file" id="importFile" style="display:none"/>
        <button id="importBtn">‚¨ÜÔ∏è Import</button>
        <button id="clearBtn">üóëÔ∏è Clear All</button>
      </div>
    </div>

    <div id="gesturesList" class="list" style="margin-top:10px;max-height:320px;overflow:auto;"></div>

    <div style="margin-top:12px;">
      <div class="bubble-area" id="bubbleArea"></div>
    </div>

    <div style="margin-top:12px;" class="flex-col">
      <div class="row">
        <button id="saveBtn" class="primary">üíæ Simpan Gestur</button>
        <button id="applySettings">Apply Settings</button>
      </div>
      <div class="small">Export/Import menyimpan seluruh template gesture (JSON). Simpan gesture sebelum export. Face expression auto diaktifkan.</div>
      <div style="margin-top:8px;">
        <label class="small">Face cooldown (ms)</label>
        <input id="faceCooldown" type="number" value="3000" style="width:120px;">
      </div>
    </div>
  </div>
</div>

<script>
/* ============================================================
   Final fixed version ‚Äî Face overlay corrected, multi-hand,
   gesture recording, auto-name, cooldown, bubble, speech
   ============================================================ */

/* ====== DOM & State ====== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const btnCamera = document.getElementById('btnCamera');
const btnFullscreen = document.getElementById('btnFullscreen');
const btnRecord = document.getElementById('btnRecord');
const btnStopRecord = document.getElementById('btnStopRecord');
const btnAutoName = document.getElementById('btnAutoName');
const btnSnapshot = document.getElementById('btnSnapshot');
const downloadLink = document.getElementById('downloadLink');

const gestureNameInput = document.getElementById('gestureName');
const gestureResponseInput = document.getElementById('gestureResponse');
const gestureCooldownInput = document.getElementById('gestureCooldown');
const sensitivityRange = document.getElementById('sensitivity');
const sVal = document.getElementById('sVal');
const globalCooldownInput = document.getElementById('globalCooldown');
const statusEl = document.getElementById('status');
const gesturesListEl = document.getElementById('gesturesList');
const bubbleArea = document.getElementById('bubbleArea');
const toggleHand = document.getElementById('toggleHand');
const toggleFace = document.getElementById('toggleFace');
const toggleVoice = document.getElementById('toggleVoice');
const toggleBubble = document.getElementById('toggleBubble');
const saveBtn = document.getElementById('saveBtn');
const applySettingsBtn = document.getElementById('applySettings');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const clearBtn = document.getElementById('clearBtn');
const faceCooldownInput = document.getElementById('faceCooldown');

let gestures = [];
let recordingFrames = [];
let isRecording = false;
let lastTrigger = 0;
let lastFaceTrigger = 0;

/* ====== Camera Setup ====== */
let cam;
btnCamera.onclick = async ()=>{
  cam = new Camera(video,{
    onFrame:async()=>{await hands.send({image:video}); await faceMesh.send({image:video})},
    width:640, height:480
  });
  cam.start();
  statusEl.textContent='Kamera aktif';
};

/* ====== MediaPipe Hands ====== */
const hands = new Hands({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.5});

/* ====== MediaPipe FaceMesh ====== */
const faceMesh = new FaceMesh({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.7,minTrackingConfidence:0.5});

/* ====== Sensitivity ====== */
sensitivityRange.oninput=()=>sVal.textContent=sensitivityRange.value;

/* ====== Gestures Render ====== */
function renderGesturesList(){
  gesturesListEl.innerHTML='';
  gestures.forEach((g,i)=>{
    const div=document.createElement('div'); div.className='gesture-item';
    div.innerHTML=`<div class="gesture-left">${g.name ||'Auto'}<span class="badge">${g.response||''}</span></div>
      <button onclick="deleteGesture(${i})">‚ùå</button>`;
    gesturesListEl.appendChild(div);
  });
}
function deleteGesture(i){gestures.splice(i,1); renderGesturesList();}

/* ====== Recording ====== */
btnRecord.onclick=()=>{isRecording=true; recordingFrames=[]; statusEl.textContent='Rekam aktif';};
btnStopRecord.onclick=()=>{isRecording=false; saveFrame(); statusEl.textContent='Rekam berhenti';};
function saveFrame(){
  if(recordingFrames.length>0){
    const name = gestureNameInput.value || `Gesture_${Date.now()}`;
    gestures.push({name, response:gestureResponseInput.value||'', frames:recordingFrames.slice(), cooldown:parseInt(gestureCooldownInput.value)});
    renderGesturesList();
    recordingFrames=[];
  }
}

/* ====== Auto-Name ====== */
btnAutoName.onclick=()=>{gestureNameInput.value=`Gesture_${Date.now()}`;};

/* ====== Snapshot ====== */
btnSnapshot.onclick=()=>{canvas.toBlob(blob=>{downloadLink.href=URL.createObjectURL(blob); downloadLink.download='snapshot.png'; downloadLink.click();});};

/* ====== Fullscreen ====== */
btnFullscreen.onclick=()=>{video.requestFullscreen();};

/* ====== Bubble ====== */
function showBubble(text){
  if(!toggleBubble.checked) return;
  const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
  bubbleArea.appendChild(b);
  setTimeout(()=>bubbleArea.removeChild(b),2800);
}

/* ====== Voice ====== */
function speak(text){if(!toggleVoice.checked) return; const u=new SpeechSynthesisUtterance(text); speechSynthesis.speak(u);}

/* ====== Face + Hand Processing ====== */
function distance2D(a,b){return Math.hypot(a.x-b.x,a.y-b.y);}
function processGestures(handsLandmarks,faceLandmarks){
  const now=Date.now();
  if(isRecording && handsLandmarks.length>0) recordingFrames.push(handsLandmarks);

  if(handsLandmarks.length>0 && toggleHand.checked){
    gestures.forEach(g=>{
      if(now-lastTrigger<parseInt(globalCooldownInput.value)) return;
      // simplistic detection: just first hand distance between thumb/index
      const d=distance2D(handsLandmarks[0][4],handsLandmarks[0][8]);
      if(d*100<sensitivityRange.value){
        lastTrigger=now;
        speak(g.response);
        showBubble(g.response);
      }
    });
  }

  if(faceLandmarks && toggleFace.checked){
    if(now-lastFaceTrigger<parseInt(faceCooldownInput.value)) return;
    lastFaceTrigger=now;
    // just example: mouth open detection
    const topLip=faceLandmarks[13], bottomLip=faceLandmarks[14];
    if(distance2D(topLip,bottomLip)*canvas.height>20){
      showBubble('üòÆ');
    }
  }
}

/* ====== Hands Callback ====== */
hands.onResults(results=>{
  const handsLandmarks=[];
  ctx.clearRect(0,0,canvas.width,canvas.height);
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  if(results.multiHandLandmarks){
    for(const hand of results.multiHandLandmarks){
      const handPx=hand.map(p=>({x:p.x*canvas.width, y:p.y*canvas.height}));
      drawConnectors(ctx,handPx,Hands.HAND_CONNECTIONS,{color:'#0ea5a9',lineWidth:2});
      drawLandmarks(ctx,handPx,{color:'#06b6d4',lineWidth:1});
      handsLandmarks.push(handPx);
    }
  }
  processGestures(handsLandmarks,lastFaceLandmarks);
});

/* ====== Face Callback ====== */
let lastFaceLandmarks=null;
faceMesh.onResults(results=>{
  lastFaceLandmarks=null;
  if(results.multiFaceLandmarks && results.multiFaceLandmarks.length>0){
    const face=results.multiFaceLandmarks[0];
    const facePx=face.map(p=>({x:p.x*canvas.width, y:p.y*canvas.height}));
    lastFaceLandmarks=facePx;
    drawConnectors(ctx,facePx,FaceMesh.FACEMESH_TESSELATION,{color:'#ffffff22',lineWidth:1});
  }
});

/* ====== Export / Import ====== */
exportBtn.onclick=()=>{const data=JSON.stringify(gestures,null,2); const blob=new Blob([data],{type:'application/json'}); downloadLink.href=URL.createObjectURL(blob); downloadLink.download='gestures.json'; downloadLink.click();};
importBtn.onclick=()=>importFile.click();
importFile.onchange=(e)=>{
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=()=>{gestures=JSON.parse(reader.result); renderGesturesList();};
  reader.readAsText(file);
};
clearBtn.onclick=()=>{gestures=[]; renderGesturesList();};

/* ====== Save Settings ====== */
saveBtn.onclick=()=>{saveFrame(); statusEl.textContent='Semua gesture tersimpan';};
applySettingsBtn.onclick=()=>{sVal.textContent=sensitivityRange.value;};

</script>
</body>
</html>
