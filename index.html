<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hand Gesture Voice ‚Äî Full Final</title>

<!-- MediaPipe CDN -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
:root{
  --bg:#071226; --card:#0c1624; --muted:#9fb0c3; --accent:#06b6d4;
  --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;}
body{margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg),#041423);
  color:#e6f0f5;font-family:Inter,system-ui,Helvetica,Arial;display:flex;justify-content:center;padding:20px;}
.wrap{width:100%; max-width:1100px; display:grid; grid-template-columns:680px 1fr; gap:18px;}
.card{background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 30px rgba(2,8,23,0.6); border:1px solid rgba(255,255,255,0.02);}
.video-box{position:relative;width:100%;height:480px;border-radius:10px;overflow:hidden;background:#000;}
#video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1);}
#canvas{position:absolute;left:0;top:0;width:100%;height:100%;pointer-events:none;transform:scaleX(-1);}
.controls{display:flex; gap:8px; flex-wrap:wrap;margin-top:10px;}
button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:var(--glass);color:var(--muted);}
button.primary{background:linear-gradient(90deg,var(--accent),#7dd3fc22); color:#021018;font-weight:700;}
input, select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;}
label{font-size:13px;color:var(--muted);}
.small{font-size:13px;color:var(--muted);}
.list{display:flex; flex-direction:column; gap:10px;}
.gesture-item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg,#071a23,#06202b); border:1px solid rgba(255,255,255,0.02);}
.gesture-left{display:flex; gap:8px; align-items:center;}
.badge{font-size:12px;color:var(--muted);}
.bubble-area{position:relative; min-height:60px;}
.bubble{position:absolute; right:10px; top:10px; background:#0ea5a9; color:#021018; padding:10px 14px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.4); animation:pop .28s ease;}
@keyframes pop{from{transform:translateY(6px) scale(.98);opacity:0} to{transform:translateY(0) scale(1);opacity:1}}
.muted-box{background:#071826;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.02);}
.footer-note{font-size:12px;color:var(--muted); margin-top:8px;}
.highlight{box-shadow:0 0 18px rgba(6,182,212,0.18); border:1px solid rgba(6,182,212,0.12);}
.row{display:flex; gap:8px; align-items:center;}
.flex-col{display:flex;flex-direction:column;gap:8px;}
.tiny{font-size:12px;color:var(--muted);}
.handLabel{font-size:12px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);}
</style>
</head>
<body>
<div class="wrap">

<!-- LEFT PANEL: VIDEO & CONTROLS -->
<div class="card">
  <div class="video-box" id="videoWrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <button id="btnCamera" class="primary">Start Camera</button>
    <button id="btnFullscreen">üñ•Ô∏è Fullscreen Kamera</button>
    <button id="btnRecord">üé• Rekam Gestur</button>
    <button id="btnStopRecord">‚èπÔ∏è Stop Rekam</button>
    <button id="btnAutoName">üîÄ Auto-Name</button>
    <button id="btnSnapshot">üì∏ Snapshot</button>
    <a id="downloadLink" style="display:none"></a>
  </div>

  <div style="display:flex;gap:12px;margin-top:12px;align-items:center;">
    <div style="flex:1;">
      <label class="small">Nama Gestur</label><br>
      <input id="gestureName" placeholder="kosongkan untuk auto-name" style="width:100%;">
    </div>
    <div style="flex:1;">
      <label class="small">Respon Suara</label><br>
      <input id="gestureResponse" placeholder="Contoh: Halo!" style="width:100%;">
    </div>
    <div style="width:140px;">
      <label class="small">Cooldown (ms)</label><br>
      <input id="gestureCooldown" type="number" value="2500" style="width:100%;">
    </div>
  </div>

  <div style="display:flex;gap:12px;margin-top:8px;align-items:center;">
    <div style="flex:1;">
      <label class="small">Sensitivity (threshold)</label>
      <input id="sensitivity" type="range" min="0.8" max="5.0" step="0.1" value="3.0" style="width:100%;">
      <div class="tiny">Nilai lebih kecil = lebih ketat (lebih sulit cocok). Saat ini: <span id="sVal">3.0</span></div>
    </div>
    <div style="width:160px;">
      <label class="small">Global cooldown (ms)</label><br>
      <input id="globalCooldown" type="number" value="500" style="width:100%;">
    </div>
  </div>

  <div class="muted-box" style="margin-top:12px;">
    <div id="status" class="small">Status: menunggu kamera...</div>
    <div class="footer-note">Tips: tahan tombol <b>Rekam Gestur</b> selama ~1 detik untuk merekam beberapa frame. Setelah tersimpan, tunjukkan gestur untuk memicu respon suara.</div>
  </div>
</div>

<!-- RIGHT PANEL: GESTURES LIST -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0">Daftar Gestur</h3>
    <div style="display:flex;gap:8px;">
      <button id="exportBtn">‚¨áÔ∏è Export</button>
      <input type="file" id="importFile" style="display:none"/>
      <button id="importBtn">‚¨ÜÔ∏è Import</button>
      <button id="clearBtn">üóëÔ∏è Clear All</button>
    </div>
  </div>

  <div id="gesturesList" class="list" style="margin-top:10px;max-height:320px;overflow:auto;"></div>

  <div style="margin-top:12px;" class="flex-col">
    <div class="row">
      <button id="saveBtn" class="primary">üíæ Simpan Gestur</button>
      <button id="applySettings">Apply Settings</button>
    </div>
    <div class="small">Export/Import menyimpan seluruh template gesture (JSON). Simpan gesture sebelum export.</div>
  </div>
</div>
</div>

<script>
/* ====== STATE & DOM ====== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const btnCamera = document.getElementById('btnCamera');
const btnFullscreen = document.getElementById('btnFullscreen');
const btnRecord = document.getElementById('btnRecord');
const btnStopRecord = document.getElementById('btnStopRecord');
const btnAutoName = document.getElementById('btnAutoName');
const btnSnapshot = document.getElementById('btnSnapshot');
const downloadLink = document.getElementById('downloadLink');

const gestureNameInput = document.getElementById('gestureName');
const gestureResponseInput = document.getElementById('gestureResponse');
const gestureCooldownInput = document.getElementById('gestureCooldown');
const sensitivityRange = document.getElementById('sensitivity');
const sVal = document.getElementById('sVal');
const globalCooldownInput = document.getElementById('globalCooldown');
const statusEl = document.getElementById('status');
const gesturesListEl = document.getElementById('gesturesList');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const clearBtn = document.getElementById('clearBtn');
const applySettingsBtn = document.getElementById('applySettings');

let cameraObj = null;
let recording = false;
let recordFrames = [];
const RECORD_FRAME_COUNT = 18;
let templates = [];
let lastGlobalTrigger = 0;

/* ====== UI HOOKS ====== */
sVal.innerText = sensitivityRange.value;
sensitivityRange.addEventListener('input', ()=> sVal.innerText = sensitivityRange.value);

/* ====== SPEECH & BUBBLE ====== */
function speak(text){
  const now = Date.now();
  const globalCd = parseInt(globalCooldownInput.value)||500;
  if(now - lastGlobalTrigger < globalCd) return;
  lastGlobalTrigger = now;

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "id-ID";
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
  showBubble(text);
}
function showBubble(text){
  bubbleArea.innerHTML = `<div class="bubble">ü§ñ ${escapeHtml(text)}</div>`;
  setTimeout(()=>{ bubbleArea.innerHTML=''; },3000);
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g,c=>'&#'+c.charCodeAt(0)+';'); }

/* ====== NORMALIZATION & COMPARISON ====== */
function normalizeLandmarks(raw){
  const ref = raw[0];
  const pts = raw.map(p=>({x:p.x-ref.x,y:p.y-ref.y}));
  let maxd = 1e-6;
  for(const p of pts){ const d=Math.hypot(p.x,p.y); if(d>maxd) maxd=d; }
  return pts.map(p=>({x:p.x/maxd,y:p.y/maxd}));
}
function averageFrames(frames){
  if(!frames.length) return null;
  const sum = Array(21).fill(0).map(()=>({x:0,y:0}));
  frames.forEach(f=>{ for(let i=0;i<21;i++){ sum[i].x+=f[i].x; sum[i].y+=f[i].y; }});
  const n = frames.length;
  return sum.map(p=>({x:p.x/n,y:p.y/n}));
}
function compareTemplates(a,b){
  let s=0;
  for(let i=0;i<21;i++){ s+=Math.abs(a[i].x-b[i].x)+Math.abs(a[i].y-b[i].y); }
  return s;
}

/* ====== TEMPLATE UI ====== */
function renderTemplates(){
  gesturesListEl.innerHTML = templates.length? '' : '<div class="tiny">(Belum ada gesture tersimpan)</div>';
  templates.forEach(t=>{
    const el = document.createElement('div'); el.className='gesture-item';
    const left = document.createElement('div'); left.className='gesture-left';
    left.innerHTML = `<div><b>${t.name}</b><div class="badge tiny">${t.response}</div></div>`;
    const right = document.createElement('div');
    right.innerHTML = `
      <div class="row">
        <button data-id="${t.id}" class="editBtn">‚úèÔ∏è</button>
        <button data-id="${t.id}" class="delBtn">üóëÔ∏è</button>
        <button data-id="${t.id}" class="testBtn">‚ñ∂Ô∏è Test</button>
      </div>
    `;
    el.appendChild(left); el.appendChild(right);
    gesturesListEl.appendChild(el);
  });

  document.querySelectorAll('.delBtn').forEach(b=>{ b.onclick=()=>{ const id=b.dataset.id; templates=templates.filter(x=>x.id!==id); renderTemplates(); }; });
  document.querySelectorAll('.editBtn').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.id; const t=templates.find(x=>x.id===id); if(!t) return;
      const newName=prompt('Ubah nama gesture',t.name); if(newName===null) return;
      const newResp=prompt('Ubah respon suara',t.response); if(newResp===null) return;
      const newCd=prompt('Cooldown (ms)',t.cooldown||gestureCooldownInput.value); if(newCd===null) return;
      t.name=newName||t.name; t.response=newResp||t.response; t.cooldown=parseInt(newCd)|| (parseInt(gestureCooldownInput.value)||2500);
      renderTemplates();
    };
  });
  document.querySelectorAll('.testBtn').forEach(b=>{ b.onclick=()=>{ const t=templates.find(x=>x.id===b.dataset.id); if(t) speak(t.response); }; });
}

/* ====== SAVE / EXPORT / IMPORT / CLEAR ====== */
saveBtn.onclick = ()=>{
  if(!recordFrames.length){ alert('Rekam gesture dulu!'); return; }
  const avg=averageFrames(recordFrames);
  if(!avg){ alert('Gagal merekam'); return; }
  const normalized=normalizeLandmarks(avg);
  const name=gestureNameInput.value.trim() || autoNameFromTemplate(normalized);
  const response=gestureResponseInput.value.trim()||'Halo';
  const cooldown=parseInt(gestureCooldownInput.value)||2500;
  const id='g'+Date.now().toString(36);
  templates.push({id,name,response,cooldown,landmarks:normalized,lastTriggered:0});
  recordFrames=[]; recording=false;
  statusEl.innerText=`‚úÖ Gestur "${name}" tersimpan. (${templates.length} total)`;
  renderTemplates();
};

exportBtn.onclick = ()=>{
  const data=JSON.stringify(templates);
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='gestures.json'; a.click();
};

importBtn.onclick = ()=> importFile.click();
importFile.onchange = e=>{
  const f=e.target.files[0];
  if(!f) return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      if(Array.isArray(data)){
        templates=data.map(d=>({...d,lastTriggered:0}));
        renderTemplates();
        statusEl.innerText='‚úÖ Import sukses.';
      }else alert('Format JSON tidak valid');
    }catch(err){ alert('File JSON tidak valid'); }
  };
  reader.readAsText(f);
};

clearBtn.onclick = ()=>{ if(confirm('Hapus semua gesture?')){ templates=[]; renderTemplates(); statusEl.innerText='Semua gesture dihapus'; } };

/* ====== AUTO NAME HEURISTIC ====== */
function autoNameFromTemplate(norm){
  try{
    const tips=[4,8,12,16,20], pips=[3,6,10,14,18];
    let ext=0;
    for(let i=0;i<5;i++){ if(norm[tips[i]].y<norm[pips[i]].y) ext++; }
    if(ext>=4) return 'open_palm';
    if(ext===0) return 'fist';
    return `${ext}_fingers`;
  }catch(e){ return 'gesture_'+Date.now().toString(36); }
}
btnAutoName.onclick = ()=>{
  if(!recordFrames.length){ alert('Rekam gesture dulu'); return; }
  const avg=averageFrames(recordFrames);
  gestureNameInput.value=autoNameFromTemplate(normalizeLandmarks(avg));
};

/* ====== RECORDING CONTROLS ====== */
btnRecord.onclick = ()=>{ recording=true; recordFrames=[]; statusEl.innerText='‚è∫Ô∏è Merekam gesture...'; };
btnStopRecord.onclick = ()=>{ recording=false; statusEl.innerText='‚èπÔ∏è Rekaman dihentikan. Klik Simpan Gestur'; };

/* ====== SNAPSHOT ====== */
btnSnapshot.onclick = ()=>{
  const temp=document.createElement('canvas'); temp.width=canvas.width; temp.height=canvas.height;
  const tctx=temp.getContext('2d');
  tctx.save(); tctx.scale(-1,1); tctx.drawImage(video,-temp.width,0,temp.width,temp.height); tctx.restore();
  tctx.drawImage(canvas,0,0,temp.width,temp.height);
  temp.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    downloadLink.href=url; downloadLink.download='snapshot.png'; downloadLink.click();
  },'image/png',0.95);
};

/* ====== FULLSCREEN ====== */
btnFullscreen.onclick = ()=>{
  const el=document.getElementById('videoWrap');
  if(!document.fullscreenElement) el.requestFullscreen();
  else document.exitFullscreen();
};

/* ====== HAND TRACKING ====== */
const hands = new Hands({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.7});
hands.onResults(onHandsResults);

const camera = new Camera(video,{onFrame: async ()=>{ await hands.send({image:video}); }, width:640,height:480});
btnCamera.onclick = ()=>{ camera.start(); statusEl.innerText='‚úÖ Kamera aktif'; };

function onHandsResults(results){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  if(results.multiHandLandmarks){
    for(const landmarks of results.multiHandLandmarks){
      drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color:'#06b6d4', lineWidth:2});
      drawLandmarks(ctx, landmarks, {color:'#0ea5a9', lineWidth:1});
      if(recording){
        recordFrames.push(landmarks.map(p=>({x:p.x,y:p.y})));
        if(recordFrames.length>RECORD_FRAME_COUNT) recordFrames.shift();
      }
      checkTemplates(landmarks);
    }
  }
}

/* ====== TEMPLATE CHECKING ====== */
function checkTemplates(landmarks){
  const norm=normalizeLandmarks(averageFrames([landmarks]));
  const now=Date.now();
  const sensitivity=parseFloat(sensitivityRange.value)||3.0;
  templates.forEach(t=>{
    if(now - (t.lastTriggered||0) < (t.cooldown||2500)) return;
    const score = compareTemplates(norm,t.landmarks);
    if(score<sensitivity){
      t.lastTriggered=now;
      speak(t.response);
    }
  });
}

/* ====== APPLY SETTINGS ====== */
applySettingsBtn.onclick = ()=>{ statusEl.innerText='‚úÖ Pengaturan diterapkan'; };
</script>

<div id="bubbleArea" class="bubble-area"></div>

</body>
</html>
