<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Hand Gesture Voice ‚Äî Stable Full</title>

<!-- MediaPipe CDN libs -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>

<style>
  :root{
    --bg:#071226; --card:#0c1624; --muted:#9fb0c3; --accent:#06b6d4;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box;}
  body{margin:0; min-height:100vh; background:linear-gradient(180deg,var(--bg),#041423); color:#e6edf3; font-family:Inter,system-ui,Helvetica,Arial; display:flex; justify-content:center; padding:20px;}
  .wrap{width:100%; max-width:1100px; display:grid; grid-template-columns:680px 1fr; gap:18px;}
  .card{background:var(--card); border-radius:12px; padding:12px; box-shadow: 0 8px 30px rgba(2,8,23,0.6); border:1px solid rgba(255,255,255,0.02);}
  .video-box{position:relative; width:100%; height:480px; border-radius:10px; overflow:hidden; background:#000;}
  #video{width:100%; height:100%; object-fit:cover; transform:scaleX(-1);}
  #canvas{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; transform:scaleX(-1);}
  .controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;}
  button{padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:var(--glass); color:var(--muted);}
  button.primary{background:linear-gradient(90deg,var(--accent),#7dd3fc22); color:#021018; font-weight:700;}
  input, select {padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit;}
  label{font-size:13px; color:var(--muted);}
  .small{font-size:13px; color:var(--muted);}
  .list{display:flex; flex-direction:column; gap:10px;}
  .gesture-item{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:8px; background:linear-gradient(180deg,#071a23,#06202b); border:1px solid rgba(255,255,255,0.02);}
  .gesture-left{display:flex; gap:8px; align-items:center;}
  .badge{font-size:12px; color:var(--muted);}
  .bubble-area{position:relative; min-height:60px;}
  .bubble{position:absolute; right:10px; background:#0ea5a9; color:#021018; padding:10px 14px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,0.4); animation:pop .28s ease;}
  @keyframes pop{from{transform:translateY(6px) scale(.98);opacity:0} to{transform:translateY(0) scale(1);opacity:1}}
  .muted-box{background:#071826;border-radius:8px;padding:8px;border:1px solid rgba(255,255,255,0.02);}
  .footer-note{font-size:12px;color:var(--muted); margin-top:8px;}
  .highlight{box-shadow:0 0 18px rgba(6,182,212,0.18); border:1px solid rgba(6,182,212,0.12);}
  .row{display:flex; gap:8px; align-items:center;}
  .flex-col{display:flex;flex-direction:column;gap:8px;}
  .tiny{font-size:12px;color:var(--muted);}
  .handLabel{font-size:12px;padding:6px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:var(--muted);}
  .toggles { display:flex; gap:8px; align-items:center; }
  .toggles label { background: rgba(255,255,255,0.02); padding:6px 8px; border-radius:8px; display:flex; align-items:center; gap:6px; color:var(--muted); border:1px solid rgba(255,255,255,0.02); }
  .toggles input[type="checkbox"]{ width:16px;height:16px; }
</style>
</head>
<body>
<div class="wrap">
<div class="card">
  <div class="video-box" id="videoWrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <button id="btnCamera" class="primary">Start Camera</button>
    <button id="btnFullscreen">üñ•Ô∏è Fullscreen Kamera</button>
    <button id="btnRecord">üé• Rekam Gestur</button>
    <button id="btnStopRecord">‚èπÔ∏è Stop Rekam</button>
    <button id="btnAutoName">üîÄ Auto-Name</button>
    <button id="btnSnapshot">üì∏ Snapshot</button>
    <a id="downloadLink" style="display:none"></a>
  </div>

  <div style="display:flex;gap:12px;margin-top:12px;align-items:center;justify-content:space-between;">
    <div style="flex:1 1 auto; display:flex; gap:12px; align-items:center;">
      <div style="flex:1;">
        <label class="small">Nama Gestur</label><br>
        <input id="gestureName" placeholder="kosongkan untuk auto-name" style="width:100%;">
      </div>
      <div style="flex:1;">
        <label class="small">Respon Suara</label><br>
        <input id="gestureResponse" placeholder="Contoh: Halo!" style="width:100%;">
      </div>
    </div>
    <div style="width:160px;">
      <label class="small">Cooldown (ms)</label><br>
      <input id="gestureCooldown" type="number" value="2500" style="width:100%;">
    </div>
  </div>

  <div style="display:flex;gap:12px;margin-top:8px;align-items:center;">
    <div style="flex:1;">
      <label class="small">Sensitivity (threshold)</label>
      <input id="sensitivity" type="range" min="0.8" max="5.0" step="0.1" value="3.0" style="width:100%;">
      <div class="tiny">Nilai lebih kecil = lebih ketat. Saat ini: <span id="sVal">3.0</span></div>
    </div>
    <div style="width:220px; display:flex; flex-direction:column; gap:6px;">
      <label class="small">Global cooldown (ms)</label>
      <input id="globalCooldown" type="number" value="500" style="width:100%;">
      <div class="toggles" style="margin-top:6px;">
        <label><input id="toggleHand" type="checkbox" checked> Hand</label>
        <label><input id="toggleFace" type="checkbox" checked> Face</label>
        <label><input id="toggleVoice" type="checkbox" checked> Voice</label>
        <label><input id="toggleBubble" type="checkbox" checked> Bubble</label>
      </div>
    </div>
  </div>

  <div class="muted-box" style="margin-top:12px;">
    <div id="status" class="small">Status: menunggu kamera...</div>
    <div class="footer-note">Tips: tahan tombol <b>Rekam Gestur</b> selama ~1 detik untuk merekam beberapa frame. Setelah tersimpan, tunjukkan gestur untuk memicu respon suara. Kamera & FaceMesh berjalan bersamaan.</div>
  </div>
</div>

<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <h3 style="margin:0">Daftar Gestur & Ekspresi</h3>
    <div style="display:flex;gap:8px;">
      <button id="exportBtn">‚¨áÔ∏è Export</button>
      <input type="file" id="importFile" style="display:none"/>
      <button id="importBtn">‚¨ÜÔ∏è Import</button>
      <button id="clearBtn">üóëÔ∏è Clear All</button>
    </div>
  </div>

  <div id="gesturesList" class="list" style="margin-top:10px;max-height:320px;overflow:auto;"></div>

  <div style="margin-top:12px;">
    <div class="bubble-area" id="bubbleArea"></div>
  </div>

  <div style="margin-top:12px;" class="flex-col">
    <div class="row">
      <button id="saveBtn" class="primary">üíæ Simpan Gestur</button>
      <button id="applySettings">Apply Settings</button>
    </div>
    <div class="small">Export/Import menyimpan seluruh template gesture (JSON). Simpan gesture sebelum export. Face expression auto diaktifkan ‚Äî ada setting cooldown wajah di bawah.</div>
    <div style="margin-top:8px;">
      <label class="small">Face cooldown (ms)</label>
      <input id="faceCooldown" type="number" value="3000" style="width:120px;">
    </div>
  </div>
</div>
</div>

<script>
/* ============================================================
   Stable version: Gesture unchanged, FaceMesh overlay accurate
   ============================================================ */

/* ===== DOM & State ===== */
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const btnCamera = document.getElementById('btnCamera');
const btnFullscreen = document.getElementById('btnFullscreen');
const btnRecord = document.getElementById('btnRecord');
const btnStopRecord = document.getElementById('btnStopRecord');
const btnAutoName = document.getElementById('btnAutoName');
const btnSnapshot = document.getElementById('btnSnapshot');
const downloadLink = document.getElementById('downloadLink');

const gestureNameInput = document.getElementById('gestureName');
const gestureResponseInput = document.getElementById('gestureResponse');
const gestureCooldownInput = document.getElementById('gestureCooldown');
const sensitivityRange = document.getElementById('sensitivity');
const sVal = document.getElementById('sVal');
const globalCooldownInput = document.getElementById('globalCooldown');
const statusEl = document.getElementById('status');
const gesturesListEl = document.getElementById('gesturesList');
const bubbleArea = document.getElementById('bubbleArea');
const saveBtn = document.getElementById('saveBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFile = document.getElementById('importFile');
const clearBtn = document.getElementById('clearBtn');
const applySettingsBtn = document.getElementById('applySettings');
const faceCooldownInput = document.getElementById('faceCooldown');

const toggleHand = document.getElementById('toggleHand');
const toggleFace = document.getElementById('toggleFace');
const toggleVoice = document.getElementById('toggleVoice');
const toggleBubble = document.getElementById('toggleBubble');

let cameraObj = null;
let recording = false;
let recordFrames = [];
const RECORD_FRAME_COUNT = 18;
let templates = [];
let lastGlobalTrigger = 0;
let lastFaceTrigger = 0;
let lastFaceExpression = null; // new: only trigger if expression berubah

/* ===== UI hookup ===== */
sVal.innerText = sensitivityRange.value;
sensitivityRange.addEventListener('input', ()=> sVal.innerText = sensitivityRange.value );

/* ===== Speech & bubble ===== */
function speak(text){
  if(!toggleVoice.checked) return;
  const now = Date.now();
  const globalCd = parseInt(globalCooldownInput.value)||500;
  if(now - lastGlobalTrigger < globalCd) return;
  lastGlobalTrigger = now;
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = document.documentElement.lang || "id-ID";
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
  if(toggleBubble.checked) showBubble(text);
}
function showBubble(text){
  if(!toggleBubble.checked) return;
  const children = bubbleArea.children.length;
  const el = document.createElement('div');
  el.className = 'bubble';
  el.style.top = `${10 + children*52}px`;
  el.textContent = `ü§ñ ${text}`;
  bubbleArea.appendChild(el);
  setTimeout(()=>{
    el.style.transition = 'opacity .18s, transform .18s';
    el.style.opacity = '0';
    el.style.transform = 'translateY(-6px)';
    setTimeout(()=> el.remove(), 180);
  }, 3000);
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>'&#'+c.charCodeAt(0)+';'); }

/* ====== Gestur normalization & comparison (stable original) ===== */
function normalizeSingle(raw){
  const ref = raw[0];
  const pts = raw.map(p => ({x:p.x-ref.x, y:p.y-ref.y}));
  let maxd=1e-6;
  pts.forEach(p=>{ const d=Math.hypot(p.x,p.y); if(d>maxd) maxd=d; });
  return pts.map(p=>({x:p.x/maxd,y:p.y/maxd}));
}
function normalizeMulti(handsArray){ return handsArray.map(normalizeSingle); }
function averageFramesMulti(frames){
  if(frames.length===0) return null;
  const handCount = frames[0].length;
  const valid = frames.filter(f=>f.length===handCount);
  if(valid.length===0) return null;
  const sumHands = [];
  for(let h=0;h<handCount;h++){
    const sum = Array(21).fill(0).map(()=>({x:0,y:0}));
    valid.forEach(f=>{ for(let i=0;i<21;i++){ sum[i].x+=f[h][i].x; sum[i].y+=f[h][i].y; } });
    const n=valid.length;
    sumHands.push(sum.map(p=>({x:p.x/n,y:p.y/n})));
  }
  return sumHands;
}
function compareSingle(a,b){ let s=0; for(let i=0;i<21;i++) s+=Math.abs(a[i].x-b[i].x)+Math.abs(a[i].y-b[i].y); return s; }
function compareMultiTemplate(templateHands,currentHands){
  if(!templateHands||!currentHands) return Infinity;
  if(templateHands.length!==currentHands.length) return Infinity;
  const n=templateHands.length;
  if(n===1) return compareSingle(templateHands[0],currentHands[0]);
  let sum=0;
  for(let i=0;i<n;i++) sum+=compareSingle(templateHands[i],currentHands[i]);
  return sum/n;
}

/* ====== Draw ===== */
function drawHands(ctx, multiLandmarks){
  if(!toggleHand.checked) return;
  multiLandmarks.forEach(hand=>{
    window.drawConnectors(ctx, hand, window.HAND_CONNECTIONS,{color:'#0ea5a9',lineWidth:2});
    window.drawLandmarks(ctx, hand,{color:'#38bdf8',lineWidth:1,radius:3});
  });
}
function drawFaceMesh(ctx, faceLandmarks){
  if(!toggleFace.checked) return;
  ctx.strokeStyle = '#f43f5e';
  ctx.lineWidth = 1;
  ctx.fillStyle = 'rgba(244,63,94,0.2)';
  faceLandmarks.forEach(p=>{
    const x = p.x*canvas.width;
    const y = p.y*canvas.height;
    ctx.beginPath();
    ctx.arc(x,y,1.5,0,2*Math.PI);
    ctx.fill();
  });
}

/* ====== MediaPipe Setup ===== */
const hands = new Hands({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
hands.setOptions({maxNumHands:2,minDetectionConfidence:0.7,minTrackingConfidence:0.6});
hands.onResults(onHandsResults);

const faceMesh = new FaceMesh({locateFile:(file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
faceMesh.setOptions({maxNumFaces:1,minDetectionConfidence:0.7,minTrackingConfidence:0.6});
faceMesh.onResults(onFaceResults);

function onHandsResults(results){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(results.multiHandLandmarks) drawHands(ctx, results.multiHandLandmarks);
  if(faceLandmarksBuffer) drawFaceMesh(ctx, faceLandmarksBuffer);

  if(recording && results.multiHandLandmarks) recordFrames.push(results.multiHandLandmarks.map(l=>l.map(p=>({x:p.x,y:p.y}))));
  
  if(results.multiHandLandmarks && templates.length){
    const normalizedCurrent = normalizeMulti(results.multiHandLandmarks.map(l=>l.map(p=>({x:p.x,y:p.y}))));
    templates.forEach(t=>{
      const score = compareMultiTemplate(t.hands,normalizedCurrent);
      const threshold = parseFloat(sensitivityRange.value)||3.0;
      const now = Date.now();
      if(score<threshold && now - (t.lastTriggered||0) > (parseInt(gestureCooldownInput.value)||2500)){
        speak(t.response||'ü§ñ Gesture detected!');
        t.lastTriggered = now;
      }
    });
  }
}

let faceLandmarksBuffer = null;
function onFaceResults(results){
  if(results.multiFaceLandmarks && results.multiFaceLandmarks[0]){
    faceLandmarksBuffer = results.multiFaceLandmarks[0];
    const now = Date.now();
    const faceCd = parseInt(faceCooldownInput.value)||3000;
    if(now - lastFaceTrigger > faceCd){
      lastFaceTrigger = now;
      if(toggleFace.checked){
        speak("üôÇ Wajah terdeteksi");
      }
    }
  }
}

/* ====== Camera ===== */
async function startCamera(){
  if(cameraObj) return;
  cameraObj = new Camera(video,{
    onFrame: async()=>{ await hands.send({image:video}); await faceMesh.send({image:video}); },
    width:680, height:480
  });
  cameraObj.start();
  statusEl.innerText = '‚úÖ Kamera aktif';
}
btnCamera.addEventListener('click', startCamera);
btnFullscreen.addEventListener('click', ()=>{ if(document.fullscreenElement){document.exitFullscreen()} else video.requestFullscreen(); });

/* ====== Gesture record ===== */
btnRecord.addEventListener('click', ()=>{
  recording = true;
  recordFrames=[];
  statusEl.innerText = 'üé• Merekam gestur...';
});
btnStopRecord.addEventListener('click', ()=>{
  recording = false;
  if(recordFrames.length){
    const avgHands = averageFramesMulti(recordFrames);
    const name = gestureNameInput.value || `Gesture_${templates.length+1}`;
    const resp = gestureResponseInput.value || 'Halo!';
    templates.push({hands:avgHands,name:name,response:resp,lastTriggered:0});
    renderGestures();
    statusEl.innerText = `‚úÖ Gestur "${name}" tersimpan!`;
    recordFrames=[];
  } else statusEl.innerText = '‚ö†Ô∏è Tidak ada frame direkam!';
});

/* ====== Render list ===== */
function renderGestures(){
  gesturesListEl.innerHTML = '';
  templates.forEach((t,i)=>{
    const div = document.createElement('div');
    div.className='gesture-item';
    div.innerHTML = `<div class="gesture-left">${escapeHtml(t.name)}</div><div class="badge">${escapeHtml(t.response)}</div>`;
    gesturesListElEl.appendChild(div);
  });
}

/* ====== Export/Import ===== */
exportBtn.addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(templates)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  downloadLink.href = url;
  downloadLink.download = 'gestures.json';
  downloadLink.click();
});

importBtn.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(f){ const reader = new FileReader(); reader.onload=()=>{ templates = JSON.parse(reader.result); renderGestures(); }; reader.readAsText(f);}
});

clearBtn.addEventListener('click', ()=>{ templates=[]; renderGestures(); });

saveBtn.addEventListener('click', ()=>{ statusEl.innerText='‚úÖ Semua gesture tersimpan (session)'; });
applySettingsBtn.addEventListener('click', ()=>{ statusEl.innerText='‚öôÔ∏è Setting diterapkan'; });

/* ===== Snapshot ===== */
btnSnapshot.addEventListener('click', ()=>{
  const snapshot = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = snapshot;
  a.download='snapshot.png';
  a.click();
});
</script>
</body>
</html>
